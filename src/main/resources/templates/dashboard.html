<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <title>Google Maps</title>
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDwwxRlB8YZVdQJBnWr0m5HsLWaqd4Txgk&callback=initMap"></script>
    <script>
        let count = 0;
        let markers = [];
        let polylines = [];
        let infoWindows = [];
        let val=0;
        let currentInfoWindow=null;

        async function fetchSchema() {
            const response1 = await fetch('/schema');
            const text1 = await response1.text();

            const list = JSON.parse(text1);
            return list;
        }

        async function fetchConfig() {
            try {
                const response = await fetch('/properties');
                const text = await response.text();
                const config = JSON.parse(text);
                return config;
            } catch (error) {
                console.error('Error fetching config:', error);
                return {};
            }
        }

        async function fetchRoute(deviceID, map, infoWindow) {
            const response = await fetch(`/devices/${deviceID}`);
            const data = await response.json();

            const RouteCoordinates = [];

            data.forEach(location => {
                const svgMarker = {
                    path: "M-1.547 12l6.563-6.609-1.406-1.406-5.156 5.203-2.063-2.109-1.406 1.406zM0 0q2.906 0 4.945 2.039t2.039 4.945q0 1.453-0.727 3.328t-1.758 3.516-2.039 3.070-1.711 2.273l-0.75 0.797q-0.281-0.328-0.75-0.867t-1.688-2.156-2.133-3.141-1.664-3.445-0.75-3.375q0-2.906 2.039-4.945t4.945-2.039z",
                    fillColor: "aqua",
                    fillOpacity: 0.0,
                    strokeWeight: 0,
                    rotation: 0,
                    scale: 2,
                    anchor: new google.maps.Point(0, 20),
                };
                var marker = new google.maps.Marker({
                    position: { lat: location.latitude, lng: location.longitude },
                    map: map,
                    title: location.name,
                    icon: svgMarker
                });
                markers.push(marker);
                RouteCoordinates.push({ lat: location.latitude, lng: location.longitude });

                const devicePath = new google.maps.Polyline({
                    path: RouteCoordinates,
                    geodesic: false,
                    strokeColor: "#FF0000",
                    strokeOpacity: 1.0,
                    strokeWeight: 2,
                });

                devicePath.setMap(map);
                polylines.push({ polyline: devicePath, infoWindow: infoWindow });
            });

            infoWindow.addListener("closeclick", function () {
                markers.forEach(marker => marker.setMap(null));
                markers = [];

                polylines = polylines.filter(item => {
                    if (item.infoWindow === infoWindow) {
                        item.polyline.setMap(null);
                        return false;
                    }
                    return true;
                });
            });
        }

        async function fetchLocations(map) {
            try {
                const response = await fetch('/devices');
                const data = await response.json();
                if (data.length === 0) {
                    console.error("No data received from /devices endpoint");
                    return;
                }

                data.forEach(location => {
                    const svgMarker = {
                        path: "M-1.547 12l6.563-6.609-1.406-1.406-5.156 5.203-2.063-2.109-1.406 1.406zM0 0q2.906 0 4.945 2.039t2.039 4.945q0 1.453-0.727 3.328t-1.758 3.516-2.039 3.070-1.711 2.273l-0.75 0.797q-0.281-0.328-0.75-0.867t-1.688-2.156-2.133-3.141-1.664-3.445-0.75-3.375q0-2.906 2.039-4.945t4.945-2.039z",
                        fillColor: "aqua",
                        fillOpacity: 0.6,
                        strokeWeight: 0,
                        rotation: 0,
                        scale: 2,
                        anchor: new google.maps.Point(0, 20),
                    };

                    var marker = new google.maps.Marker({
                        position: { lat: location.latitude, lng: location.longitude },
                        map: map,
                        title: location.name,
                        icon: svgMarker
                    });

                    let id = location.device_Id;

                    var infoWindow = new google.maps.InfoWindow({
                        content: `<div>
                                  <h3>${location.device_Id}</h3>
                                  <p>Latitude: ${location.latitude}</p>
                                  <p>Longitude: ${location.longitude}</p>
                                  <button onclick="openSidePanel('${location.device_Id}', '${infoWindow}', ${location.longitude})">More Info</button>
                                  </div>`
                    });

                    infoWindows.push(infoWindow);

                    marker.addListener('click', function () {
                        fetchRoute(id.replace("Device ", ""), map, infoWindow);
                    });

                    marker.addListener('click', function () {
                        if(currentInfoWindow){
                           currentInfoWindow.close();
                           removePolylines();
                        }
                        currentInfoWindow=infoWindow;
                        infoWindow.open(map, marker);
                    });

                    infoWindow.addListener('closeclick', function () {
                        markers.forEach(marker => marker.setMap(null));
                        markers = [];

                        polylines = polylines.filter(item => {
                           if (item.infoWindow === infoWindow) {
                               item.polyline.setMap(null);

                           }
                        });
                        closeSidePanel();
                    });
                });
            } catch (error) {
                console.error('Error fetching locations:', error);
            }
        }

        async function initMap() {
            const response = await fetch('/devices');
            const data = await response.json();
            if (data.length === 0) {
                console.error("No data received from /devices endpoint");
                return;
            }

            const map = new google.maps.Map(document.getElementById('map'), {
                zoom: 4,
                center: { lat: data[0].latitude, lng: data[0].longitude },
                fullscreenControl: false,
                mapId: '2bb76ea8d1bd2716'
            });

            const buttons = [
                ["Rotate Left", "rotate", 20, google.maps.ControlPosition.LEFT_CENTER],
                ["Rotate Right", "rotate", -20, google.maps.ControlPosition.RIGHT_CENTER],
                ["Tilt Down", "tilt", 20, google.maps.ControlPosition.TOP_CENTER],
                ["Tilt Up", "tilt", -20, google.maps.ControlPosition.BOTTOM_CENTER],
            ];

            buttons.forEach(([text, mode, amount, position]) => {
                const controlDiv = document.createElement("div");
                const controlUI = document.createElement("button");

                controlUI.classList.add("ui-button");
                controlUI.innerText = `${text}`;
                controlUI.addEventListener("click", () => {
                    adjustMap(mode, amount);
                });
                controlDiv.appendChild(controlUI);
                map.controls[position].push(controlDiv);
            });

            const adjustMap = function (mode, amount) {
                switch (mode) {
                    case "tilt":
                        map.setTilt(map.getTilt() + amount);
                        break;
                    case "rotate":
                        map.setHeading(map.getHeading() + amount);
                        break;
                    default:
                        break;
                }
            };

            infoWindow = new google.maps.InfoWindow();

            const locationButton = document.createElement("button");

            locationButton.textContent = "Pan to Current Location";
            locationButton.classList.add("custom-map-control-button");
            map.controls[google.maps.ControlPosition.TOP_CENTER].push(locationButton);
            locationButton.addEventListener("click", () => {
                if (navigator.geolocation) {
                    navigator.geolocation.getCurrentPosition(
                        (position) => {
                            const pos = {
                                lat: position.coords.latitude,
                                lng: position.coords.longitude,
                            };

                            infoWindow.setPosition(pos);
                            infoWindow.setContent("Location found.");
                            infoWindow.open(map);
                            map.setCenter(pos);
                        },
                        () => {
                            handleLocationError(true, infoWindow, map.getCenter());
                        },
                    );
                } else {
                    handleLocationError(false, infoWindow, map.getCenter());
                }
            });

            fetchLocations(map);

            setInterval(() => {
                fetchLocations(map);
            }, 1000);
        }

        async function openSidePanel(deviceId, lat, lon) {
            val++;
            count++;
            if (count > 1) {
                clearInterval(code);
                count--;
            }

            const config = await fetchConfig();
            const interval = config.interval;
            const sidePanelWidth = config.sidePanelWidth;
            const initialPoint = config.initialPoint;
            const finalPoint = config.finalPoint;

            deviceId = deviceId.replace("Device ", "");
            const sP = document.getElementById("side-panel");
            sP.style.width = sidePanelWidth;
            sP.innerHTML = `
                <a href="javascript:void(0)" id="cross" class="closebtn" onclick="closeSidePanel()">&times;</a>
                <p>Device ID: ${deviceId}</p>`;
            const size = finalPoint - initialPoint;
            for (let i = 1; i <= size; i++) {
                document.getElementById("side-panel").innerHTML += `<p>Humidity: <span id="h${i}"> </span> &nbsp;&nbsp;&nbsp;&nbsp; Temperature: <span id="t${i}"> </span></p>`;
            }

            const lis = await fetchSchema();

            code = setInterval(function () {
                fetch(`/devicedata/${deviceId}`)
                    .then(response => response.json())
                    .then(data => {
                        let hum = lis[2].toLowerCase();
                        let temp = lis[3].toLowerCase();

                        const latestData = data.reverse().slice(initialPoint, finalPoint);

                        for (let i = 1; i <= size; i++) {
                            const hElement = document.getElementById(`h${i}`);
                            const tElement = document.getElementById(`t${i}`);

                            if (latestData[i - 1]) {
                                hElement.innerText = latestData[i - 1][hum];
                                tElement.innerText = latestData[i - 1][temp];
                            } else {
                                hElement.innerText = '';
                                tElement.innerText = '';
                            }
                        }
                    })
                    .catch(error => console.error('Error fetching device data:', error));
            }, interval);
        }

        function closeSidePanel() {
            clearInterval(code);
            document.getElementById("side-panel").innerHTML = ``;
            document.getElementById("side-panel").style.width = "0";
        }

        function closeSidePanelWithoutInterval() {
            document.getElementById("side-panel").innerHTML = ``;
            document.getElementById("side-panel").style.width = "0";
        }
        function removePolylines(){
            markers.forEach(marker => marker.setMap(null));
            markers = [];

            polylines.filter(item => {
              item.polyline.setMap(null);
            });
        }
    </script>
    <style>
        body {
            margin: 0px;
        }

        #side-panel {
            position: fixed;
            right: 0;
            top: 0;
            width: 0;
            height: 100%;
            background-color: white;
            overflow-x: hidden;
            transition: 0.5s;
            box-shadow: -2px 0 5px rgba(0, 0, 0, 0.5);
            padding: 20px;
            border-left: 1px solid #ddd;
            z-index: 9999;
        }

        #side-panel p {
            margin-left: 7px 0;
        }

        .closebtn {
            position: absolute;
            top: 10px;
            right: 25px;
            font-size: 36px;
            text-decoration: none;
            color: black;
            position: relative;
            left: 0.2px;
        }

        #side-panel .closebtn:hover {
            color: red;
        }
    </style>
</head>

<body onload="initMap()">

<div id="map" style="height: 559px; width: 96.8%;"></div>
<div id="side-panel"></div>

</body>
</html>
